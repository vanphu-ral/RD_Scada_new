<div class="">
    <div class="base-table-header my-3 d-flex px-2">
        <h2 class="text-xl font-bold text-dark">Truy suất nguồn gốc serial</h2>
    </div>
    <div class="d-flex mb-3">
        <input type="text" pInputText placeholder="Serial" class="mx-2" [(ngModel)]="filter.serial" (keyup.enter)="search()">
        <p-select [options]="optionSerial" [(ngModel)]="filter.option" optionLabel="name" placeholder="Chọn loại serial"
            class="w-full md:w-56 mx-2" optionValue="value" />
        <p-button icon="pi pi-search" class="p-button-text" severity="info" clas="mx-2" label="Search"
            (onClick)="search()"></p-button>
        <p-button label="Clear Data" class="mx-2" (onClick)="clearData()" />

    </div>
    <div class="mt-5" *ngIf="true">
        <p-table [loading]="loading" class=" mb-5" [value]="data?.planningWO ? [data?.planningWO] : []">
            <ng-template pTemplate="caption">
                <span class="text-xl font-bold">Thông tin sản xuất</span>
            </ng-template>

            <ng-template pTemplate="header">
                <tr>
                    <th>Mã sản phẩm</th>
                    <th>Tên sản phẩm</th>
                    <th>Version</th>
                    <th>Mã WO</th>
                    <th>Số Lô</th>
                    <th>Mã lệnh SAP</th>
                    <th>Số lượng kế hoạch</th>
                    <th>Thời gian phát hành</th>
                    <th>Thời gian bắt đầu</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>{{ item.productCode }}</td>
                    <td>{{ item.productName }}</td>
                    <td>{{ item.bomVersion }}</td>
                    <td>{{ item.woId }}</td>
                    <td>{{ item.lotNumber }}</td>
                    <td>{{ item.sapWoId }}</td>
                    <td>{{ item.quantityPlan }}</td>
                    <td>{{ item.createTime | date : 'dd/MM/yyyy HH:mm:ss' }}</td>
                    <td>{{ item.startTime | date : 'dd/MM/yyyy HH:mm:ss' }}</td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9" class="text-center py-3">Không tìm thấy dữ liệu</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="mt-5" *ngIf="true">
        <p-table [loading]="loading" class="" [value]="data?.scanSerialChecks || []" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20,50]" currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} mục" [showCurrentPageReport]="true">
            <ng-template pTemplate="caption">
                <span class="text-xl font-bold">Thông tin chi tiết các công đoạn sản xuất</span>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>Mã WO</th>
                    <th>Serial board / Product</th>
                    <th>Serial PCS</th>
                    <th>Công đoạn sản xuất</th>
                    <th>Machine</th>
                    <th>Trạng thái</th>
                    <th>Thời gian</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>{{ item.workOrder }}</td>
                    <td>{{ item.serialBoard }}</td>
                    <td>{{ item.serialItem }}</td>
                    <td>{{ item.stageNum }}</td>
                    <td>{{ item.machineName }}</td>
                    <td>{{ item.serialStatus }}</td>
                    <td>{{ item.timeScan | date : 'dd/MM/yyyy HH:mm:ss' }}</td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="11" class="text-center py-3">Không tìm thấy dữ liệu</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="mt-5" *ngIf="true">
        <p-table [loading]="loading" class="" [value]="listDataFCTATE || []" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20,50]" currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} mục" [showCurrentPageReport]="true">
            <ng-template pTemplate="caption">
                <div class="d-flex align-items-center justify-content-between">
                    <span class="text-xl font-bold">Thông số điện</span>
                    <p-button icon="pi pi-file-excel" class="p-button-text" severity="success" label="Export Excel" (onClick)="exportExcel()"></p-button>
                </div>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>ProgramName</th>
                    <th>StageName</th>
                    <th>DetailSerial</th>
                    <th>Results</th>
                    <th>FixLR</th>
                    <th>FixID</th>
                    <th>StartTestTime</th>
                    <th>EndTestTime</th>
                    <th>TimeElapsed</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>{{ item.detailParams.data.ProgramName }}</td>
                    <td>{{ item.machineName }}</td>
                    <td>{{ item.detailParams.data.SerialSelected }}</td>
                    <td>{{ item.detailParams.data.SerialStatus }}</td>
                    <td>{{ item.detailParams.data.FixLR }}</td>
                    <td>{{ item.detailParams.data.FixId }}</td>
                    <td>{{ item.detailParams.data.TimeStart }}</td>
                    <td>{{ item.detailParams.data.EndTest }}</td>
                    <td>{{ item.detailParams.data.TimeElapsed }}</td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="11" class="text-center py-3">Không tìm thấy dữ liệu</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="mt-5" *ngIf="true">
        <p-table [loading]="loading" class="" [value]="listDataLUYEN || []" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20,50]" currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} mục" [showCurrentPageReport]="true">
            <ng-template pTemplate="caption">
                <div class="d-flex align-items-center justify-content-between">
                    <span class="text-xl font-bold">Thông số luyện</span>
                    <p-button icon="pi pi-file-excel" class="p-button-text" severity="success" label="Export Excel" (onClick)="exportExcelLuyen()"></p-button>
                </div>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>Thời gian luyện</th>
                    <th>Nhiệt độ</th>
                    <th>Điện áp vào</th>
                    <th>Điện áp ra</th>
                    <th>Dòng ra</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr class="bg-gray-100 font-bold">
                    <td colspan="5" style="background-color: #f8f9fa;">
                        <div class="flex align-items-center">
                            <span class="text-primary">SERIAL: {{item.serial}}</span>
                            <span class="ml-4 text-600">| WO: {{item.workOrder}}</span>
                            <span class="ml-4">| Kết quả:
                                <span [class]="item.results === 'OK' ? 'text-green-500' : 'text-red-500'">
                                    {{item.results}}
                                </span>
                            </span>
                        </div>
                    </td>
                </tr>
            
                <tr *ngFor="let child of item.detailParams?.data">
                    <td>{{child.date}}</td>
                    <td>{{child.Temp}}</td>
                    <td>{{child.U_in}}</td>
                    <td>{{child.U_out}}</td>
                    <td>{{child.I_out}}</td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="11" class="text-center py-3">Không tìm thấy dữ liệu</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="mt-5">
        <p-table [loading]="loading" class="" [value]="listBOMInfo" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20,50]" currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} mục" [showCurrentPageReport]="true">
            <ng-template pTemplate="caption">
                <span class="text-xl font-bold">Thông tin BOM sản phẩm</span>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>Mã WO</th>
                    <th>Mã hàng hóa</th>
                    <th>Tên hàng hóa</th>
                    <th>Vendor</th>
                    <th>PartNumber</th>
                    <th>Số lượng cơ bản</th>
                    <th>Số lượng cần sx</th>
                    <th>Tổng lỗi</th>
                    <th>Tổng thực nhập sx</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>{{ data.planningWO.woId }}</td>
                    <td>{{ item.itemCode }}</td>
                    <td>{{ item.itemName }}</td>
                    <td>{{ item.vendor }}</td>
                    <td>{{ item.partNumber }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.workOrderQuantity }}</td>
                    <td>{{ getQuantity(item.id) }}</td>
                    <td>{{ getError(item.id) }}</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="11" class="text-center py-3">Không tìm thấy dữ liệu</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="mt-5">
        <p-table [loading]="loading" class="" [value]="listMaterialCheck" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20,50]" currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} mục" [showCurrentPageReport]="true">
            <ng-template pTemplate="caption">
                <span class="text-xl font-bold">Thông tin kiểm tra vật tư</span>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>Mã WO</th>
                    <th>Mã hàng hóa</th>
                    <th>Tên hàng hóa</th>
                    <th>Vendor</th>
                    <th>PartNumber</th>
                    <th>Số mẫu kiểm tra</th>
                    <th>Quy định kiểm tra</th>
                    <th>Số lỗi cho phép</th>
                    <th>Số lỗi thực tế</th>
                    <th>Ngày về</th>
                    <th>Người kiểm tra</th>
                    <th>Kết luận</th>
                    <th>Ngày kiểm tra</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="rowIndex">
                <tr>
                    <td>{{ data.planningWO.woId }}</td>
                    <td>{{ item.itemCode }}</td>
                    <td>{{ item.itemName }}</td>
                    <td>{{ item.vendor }}</td>
                    <td>{{ item.partNumber }}</td>
                    <td>{{ item.sampleQuantity }}</td>
                    <td>{{ item.regulationCheck }}</td>
                    <td>{{ item.allowResult }}</td>
                    <td>{{ item.realResult }}</td>
                    <td>{{ item.returnDay | date : 'dd/MM/yyyy' }}</td>
                    <td style="border-top: 1px solid; border-left: 1px solid;" *ngIf="shouldShowPerson(i)" [attr.rowspan]="getRowSpan(item.CheckPerson)">{{ item.CheckPerson }}</td>
                    <td style="border-top: 1px solid;" *ngIf="shouldShowPerson(i)" [attr.rowspan]="getRowSpan(item.CheckPerson)">{{ item.conclude }}</td>
                    <td style="border-top: 1px solid;" *ngIf="shouldShowPerson(i)" [attr.rowspan]="getRowSpan(item.CheckPerson)">{{ item.checkDate | date : 'dd/MM/yyyy' }}</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="99" class="text-center py-3">Không tìm thấy dữ liệu</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="mt-5">
        <p-table [loading]="loading" class="" [value]="listMaterialUse" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20,50]" currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} mục" [showCurrentPageReport]="true">
            <ng-template pTemplate="caption">
                <span class="text-xl font-bold">Thông tin sử dụng vật tư</span>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>Mã WO</th>
                    <th>Mã máy</th>
                    <th>Mã Feeder/Station</th>
                    <th>Partnumber</th>
                    <th>Material</th>
                    <th>QR Detail</th>
                    <th>Thời gian Scan</th>
                    <th>Người vận hành</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>{{ data.planningWO.woId }}</td>
                    <td>{{ item.machine }}</td>
                    <td>{{ item.feeder }}</td>
                    <td>{{ getPartNumber(item.qr) }}</td>
                    <td>{{ item.material }}</td>
                    <td>{{ item.qr }}</td>
                    <td>{{ item.createdAt | date : 'dd/MM/yyyy HH:mm:ss' }}</td>
                    <td>{{ item.user_check }}</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="11" class="text-center py-3">Không tìm thấy dữ liệu</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="mt-5">
        <p-table [loading]="loading" class="" [value]="listMaterialNotRecommend" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5,10,20,50]" currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} mục" [showCurrentPageReport]="true">
            <ng-template pTemplate="caption">
                <span class="text-xl font-bold">Danh sách vật tư không thuộc khuyến nghị</span>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th>Mã WO</th>
                    <th>Mã máy</th>
                    <th>Mã Feeder/Station</th>
                    <th>Partnumber</th>
                    <th>Material</th>
                    <th>QR Detail</th>
                    <th>Thời gian Scan</th>
                    <th>Người vận hành</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item>
                <tr>
                    <td>{{ data.planningWO.woId }}</td>
                    <td>{{ item.machine }}</td>
                    <td>{{ item.feeder }}</td>
                    <td>{{ getPartNumber(item.qr) }}</td>
                    <td>{{ item.material }}</td>
                    <td>{{ item.qr }}</td>
                    <td>{{ item.createdAt | date : 'dd/MM/yyyy HH:mm:ss' }}</td>
                    <td>{{ item.user_check }}</td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="11" class="text-center py-3">Không tìm thấy dữ liệu</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>